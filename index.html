<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaCare - Final</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-color: #4f46e5; --primary-color-dark: #4338ca; --secondary-color: #10b981;
            --danger-color: #ef4444; --dark-color: #111827; --dark-alt-color: #1f2937;
            --light-color: #f9fafb; --grey-color: #6b7280; --white-color: #ffffff;
            --font-family: 'Poppins', sans-serif; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            --radius-md: 8px; --radius-lg: 12px; --transition-speed: 0.3s;
        }
        body { font-family: var(--font-family); background-color: var(--light-color); color: var(--dark-alt-color); line-height: 1.6; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: linear-gradient(180deg, var(--dark-color) 0%, var(--dark-alt-color) 100%); color: var(--light-color); padding: 20px 0; position: fixed; height: 100vh; overflow-y: auto; transition: all var(--transition-speed) ease; z-index: 1000; }
        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed .logo h2, .sidebar.collapsed .menu-item-text { display: none; }
        .logo { padding: 0 25px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; gap: 12px; }
        .logo .bi-capsule-pill { font-size: 2rem; color: var(--secondary-color); }
        .logo h2 { font-size: 1.5rem; font-weight: 600; color: var(--white-color); white-space: nowrap; }
        .menu { list-style: none; padding: 20px 0; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: all var(--transition-speed) ease; display: flex; align-items: center; gap: 15px; border-left: 4px solid transparent; color: var(--grey-color); }
        .menu-item:hover { background: rgba(255, 255, 255, 0.05); border-left-color: var(--secondary-color); color: var(--white-color); }
        .menu-item.active { background: linear-gradient(90deg, rgba(79, 70, 229, 0.3), transparent); border-left-color: var(--primary-color); color: var(--white-color); }
        .menu-item-icon { font-size: 1.5rem; min-width: 30px; }
        .toggle-btn { position: absolute; top: 25px; right: -15px; background: var(--primary-color); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; transition: transform var(--transition-speed) ease; }
        .toggle-btn:hover { transform: scale(1.1); }
        .main-content { flex: 1; margin-left: 260px; padding: 25px; transition: margin-left var(--transition-speed) ease; }
        .main-content.expanded { margin-left: 80px; }
        .header { background: var(--white-color); padding: 20px 25px; border-radius: var(--radius-lg); margin-bottom: 25px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { color: var(--dark-color); font-size: 1.8rem; font-weight: 600; }
        .date-display { color: var(--primary-color); font-weight: 500; background-color: #eef2ff; padding: 8px 15px; border-radius: var(--radius-md); }
        .page { display: none; } .page.active { display: block; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .card { background: var(--white-color); padding: 25px; border-radius: var(--radius-lg); box-shadow: var(--shadow); transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; border: 1px solid #e5e7eb; }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .card-title { font-size: 0.9rem; color: var(--grey-color); font-weight: 500; }
        .card-icon { font-size: 1.8rem; padding: 10px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .card-value { font-size: 2.2rem; font-weight: 600; color: var(--dark-color); }
        .icon-sales { color: #2563eb; background: #dbeafe; } .icon-pharma { color: #16a34a; background: #dcfce7; } .icon-nonpharma { color: #c026d3; background: #fce7f3; } .icon-delivery { color: #d97706; background: #fef3c7; } .icon-monthly { color: #db2777; background: #fce7f3; } .icon-audit { color: #6d28d9; background: #ede9fe; }
        .form-container, .table-container, .filter-section, .settings-group { background: var(--white-color); padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow); margin-bottom: 25px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group label { margin-bottom: 8px; font-weight: 500; color: var(--dark-alt-color); display: block; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 1px solid #d1d5db; border-radius: var(--radius-md); font-size: 1rem; font-family: var(--font-family); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        .form-group input.error { border-color: var(--danger-color); }
        .error-message { color: var(--danger-color); font-size: 0.85rem; margin-top: 5px; display: none; }
        .error-message.show { display: block; }
        .btn { padding: 12px 24px; border: none; border-radius: var(--radius-md); font-size: 1rem; font-weight: 600; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 8px; text-transform: capitalize; }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn-primary { background: var(--primary-color); color: var(--white-color); } .btn-primary:hover { background: var(--primary-color-dark); } .btn-success { background: var(--secondary-color); color: var(--white-color); } .btn-danger { background: var(--danger-color); color: var(--white-color); } .btn-warning { background: #f59e0b; color: var(--white-color); } .btn-info { background: #3b82f6; color: var(--white-color); }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .table-container { overflow-x: auto; }
        .export-section { margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: var(--radius-md); }
        .export-section h4 { margin-bottom: 10px; color: var(--dark-color); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        thead { background: var(--light-color); border-bottom: 2px solid #e5e7eb; }
        th, td { padding: 15px; text-align: left; }
        th { font-weight: 600; color: var(--dark-color); }
        tbody tr { border-bottom: 1px solid #e5e7eb; }
        tbody tr:last-child { border-bottom: none; }
        tbody tr:hover { background: #f3f4f6; }
        .action-btn { padding: 6px 10px; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 0.9rem; margin-right: 5px; color: white; transition: opacity var(--transition-speed) ease; }
        .action-btn:hover { opacity: 0.8; }
        .delete-btn { background: var(--danger-color); }
        .chart-container { background: var(--white-color); padding: 20px; border-radius: var(--radius-lg); box-shadow: var(--shadow); margin-bottom: 25px; height: 400px; }
        .alert { padding: 15px 20px; border-radius: var(--radius-md); margin-bottom: 20px; display: none; border-left: 5px solid; }
        .alert.show { display: block; }
        .alert-success { background: #f0fdf4; color: #15803d; border-color: #22c55e; } .alert-error { background: #fef2f2; color: #b91c1c; border-color: #ef4444; } .alert-warning { background: #fef3c7; color: #92400e; border-color: #f59e0b; }
        .category-list { list-style: none; margin-top: 15px; }
        .category-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #e5e7eb; border-radius: var(--radius-md); margin-bottom: 8px; }
        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1001; background: var(--primary-color); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; box-shadow: var(--shadow-lg); }
        .mobile-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
        .net-sale-card { grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .net-sale-card .card-title, .net-sale-card .card-value { color: white; }
        .net-sale-details { display: flex; gap: 30px; margin-top: 15px; flex-wrap: wrap; }
        .net-sale-item { flex: 1; min-width: 150px; }
        .net-sale-item-label { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; }
        .net-sale-item-value { font-size: 1.5rem; font-weight: 600; }
        @media (max-width: 992px) { .sidebar { transform: translateX(-100%); } .sidebar.mobile-open { transform: translateX(0); } .main-content, .main-content.expanded { margin-left: 0; } .mobile-menu-btn { display: flex; align-items: center; justify-content: center; } .mobile-backdrop.active { display: block; } }
        @media (max-width: 576px) { .main-content { padding: 15px; } .header, .form-container, .table-container, .settings-group { padding: 20px; } .btn-group { flex-direction: column; } .btn { width: 100%; justify-content: center; } }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="bi bi-list"></i></button>
    <div class="mobile-backdrop" id="mobileBackdrop" onclick="toggleMobileMenu()"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <button class="toggle-btn" onclick="toggleSidebar()"><i class="bi bi-chevron-left"></i></button>
            <div class="logo"><i class="bi bi-capsule-pill"></i><h2>PharmaCare</h2></div>
            <ul class="menu">
                <li class="menu-item active" onclick="showPage('dashboard', event)"><i class="menu-item-icon bi bi-grid-1x2-fill"></i><span class="menu-item-text">Dashboard</span></li>
                <li class="menu-item" onclick="showPage('dailySales', event)"><i class="menu-item-icon bi bi-cash-coin"></i><span class="menu-item-text">Daily Sales</span></li>
                <li class="menu-item" onclick="showPage('saleHistory', event)"><i class="menu-item-icon bi bi-clock-history"></i><span class="menu-item-text">Sale History</span></li>
                <li class="menu-item" onclick="showPage('homeDelivery', event)"><i class="menu-item-icon bi bi-truck"></i><span class="menu-item-text">Home Delivery</span></li>
                <li class="menu-item" onclick="showPage('memberShip', event)"><i class="menu-item-icon bi bi-person-badge-fill"></i><span class="menu-item-text">MemberShip</span></li>
                <li class="menu-item" onclick="showPage('dailyAudit', event)"><i class="menu-item-icon bi bi-clipboard-check-fill"></i><span class="menu-item-text">Daily Audit</span></li>
                <li class="menu-item" onclick="showPage('category', event)"><i class="menu-item-icon bi bi-tags-fill"></i><span class="menu-item-text">Category</span></li>
                <li class="menu-item" onclick="showPage('reports', event)"><i class="menu-item-icon bi bi-bar-chart-line-fill"></i><span class="menu-item-text">Reports</span></li>
                <li class="menu-item" onclick="showPage('settings', event)"><i class="menu-item-icon bi bi-gear-fill"></i><span class="menu-item-text">Settings</span></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <div class="alert" id="alertMessage"></div>
            
            <!-- Dashboard Page -->
            <div class="page active" id="dashboard">
                <div class="header"><h1>Dashboard</h1><div class="date-display" id="currentDate"></div></div>
                <div class="cards-grid">
                    <!-- Net Total Daily Sale Card (Full Width) -->
                    <div class="card net-sale-card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Net Total Daily Sale</div>
                                <div class="card-value" id="netDailyTotal">₹0.00</div>
                            </div>
                            <div class="card-icon" style="background: rgba(255,255,255,0.2); color: white;">
                                <i class="bi bi-graph-up-arrow"></i>
                            </div>
                        </div>
                        <div class="net-sale-details">
                            <div class="net-sale-item">
                                <div class="net-sale-item-label">Pharma Sales</div>
                                <div class="net-sale-item-value" id="netDailyPharma">₹0.00</div>
                            </div>
                            <div class="net-sale-item">
                                <div class="net-sale-item-label">Non-Pharma Sales</div>
                                <div class="net-sale-item-value" id="netDailyNonPharma">₹0.00</div>
                            </div>
                            <div class="net-sale-item">
                                <div class="net-sale-item-label">Total Transactions</div>
                                <div class="net-sale-item-value" id="netDailyTransactions">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="card"><div class="card-header"><div><div class="card-title">Today's Total Sales</div><div class="card-value" id="todayTotal">₹0.00</div></div><div class="card-icon icon-sales"><i class="bi bi-currency-rupee"></i></div></div></div>
                    <div class="card"><div class="card-header"><div><div class="card-title">Pharma Sales</div><div class="card-value" id="todayPharma">₹0.00</div></div><div class="card-icon icon-pharma"><i class="bi bi-capsule"></i></div></div></div>
                    <div class="card"><div class="card-header"><div><div class="card-title">Non-Pharma Sales</div><div class="card-value" id="todayNonPharma">₹0.00</div></div><div class="card-icon icon-nonpharma"><i class="bi bi-basket-fill"></i></div></div></div>
                    <div class="card"><div class="card-header"><div><div class="card-title">Pending Deliveries</div><div class="card-value" id="todayDeliveries">0</div></div><div class="card-icon icon-delivery"><i class="bi bi-truck"></i></div></div></div>
                    <div class="card"><div class="card-header"><div><div class="card-title">Monthly Sales</div><div class="card-value" id="monthlyTotal">₹0.00</div></div><div class="card-icon icon-monthly"><i class="bi bi-calendar-month"></i></div></div></div>
                    <div class="card"><div class="card-header"><div><div class="card-title">Audits Today</div><div class="card-value" id="totalAudits">0</div></div><div class="card-icon icon-audit"><i class="bi bi-clipboard2-check-fill"></i></div></div></div>
                </div>
                <div class="cards-grid" style="grid-template-columns: 2fr 1fr;"><div class="chart-container"><canvas id="salesChart"></canvas></div><div class="chart-container"><canvas id="categoryChart"></canvas></div></div>
            </div>

            <!-- Daily Sales Page -->
            <div class="page" id="dailySales">
                 <div class="header"><h1>Daily Sales Entry</h1></div>
                <div class="form-container">
                    <form id="dailySalesForm">
                        <div class="form-grid">
                            <div class="form-group"><label for="saleDate">Date *</label><input type="date" id="saleDate" required></div>
                            <div class="form-group"><label for="pharmaAmount">Pharma Sales (₹) *</label><input type="number" id="pharmaAmount" step="0.01" min="0" required placeholder="0.00"></div>
                            <div class="form-group"><label for="nonPharmaAmount">Non-Pharma Sales (₹) *</label><input type="number" id="nonPharmaAmount" step="0.01" min="0" required placeholder="0.00"></div>
                        </div>
                        <div class="btn-group"><button type="submit" class="btn btn-primary"><i class="bi bi-save-fill"></i> Save Sale</button><button type="button" class="btn btn-warning" onclick="this.closest('form').reset();"><i class="bi bi-arrow-counterclockwise"></i> Reset</button></div>
                    </form>
                </div>
                <div class="table-container"><h3>Recent Sales</h3><table><thead><tr><th>Date</th><th>Pharma (₹)</th><th>Non-Pharma (₹)</th><th>Total (₹)</th><th>Actions</th></tr></thead><tbody id="recentSalesTable"></tbody></table></div>
            </div>
            
            <!-- Sale History Page -->
            <div class="page" id="saleHistory">
                <div class="header"><h1>Sales History</h1></div>
                <div class="table-container"><table><thead><tr><th>Date</th><th>Pharma (₹)</th><th>Non-Pharma (₹)</th><th>Total (₹)</th><th>Actions</th></tr></thead><tbody id="saleHistoryTable"></tbody></table></div>
            </div>

            <!-- Home Delivery Page -->
            <div class="page" id="homeDelivery">
                <div class="header"><h1>Home Delivery Management</h1></div>
                <div class="form-container">
                    <h3>New Delivery Order</h3>
                    <form id="deliveryForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Customer ID *</label>
                                <input type="text" id="deliveryCustomerId" required placeholder="e.g., CUST001">
                            </div>
                            <div class="form-group">
                                <label>Order Date *</label>
                                <input type="date" id="deliveryDate" required>
                            </div>
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" id="deliveryCustomer" required placeholder="Enter customer name">
                            </div>
                            <div class="form-group">
                                <label>Phone Number (10 digits) *</label>
                                <input type="tel" id="deliveryPhone" required pattern="[0-9]{10}" maxlength="10" minlength="10" placeholder="10 digit mobile number">
                                <span class="error-message" id="deliveryPhoneError">Please enter valid 10 digit phone number</span>
                            </div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="deliveryStatus" required>
                                    <option value="Pending">Pending</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Delivery Address *</label>
                            <textarea id="deliveryAddress" rows="3" required placeholder="Enter complete delivery address"></textarea>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-save-fill"></i> Save Order</button>
                            <button type="button" class="btn btn-warning" onclick="this.closest('form').reset();"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="deliveryTableContainer">
                    <div class="export-section">
                        <h4><i class="bi bi-download"></i> Export Delivery Data</h4>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="exportDeliveryExcel()"><i class="bi bi-file-earmark-excel-fill"></i> Excel</button>
                            <button class="btn btn-danger" onclick="exportDeliveryPDF()"><i class="bi bi-file-earmark-pdf-fill"></i> PDF</button>
                            <button class="btn btn-info" onclick="exportDeliveryImage()"><i class="bi bi-image-fill"></i> Image</button>
                        </div>
                    </div>
                    <h3>Delivery Orders</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Address</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deliveryTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- MemberShip Page -->
            <div class="page" id="memberShip">
                <div class="header"><h1>MemberShip Management</h1></div>
                <div class="form-container">
                     <h3>New MemberShip Entry</h3>
                    <form id="memberShipForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="memberShipDate">Date *</label>
                                <input type="date" id="memberShipDate" required>
                            </div>
                            <div class="form-group">
                                <label for="memberShipName">Employee Name *</label>
                                <input type="text" id="memberShipName" required placeholder="e.g., Jane Smith">
                            </div>
                            <div class="form-group">
                                <label for="memberShipQuantity">Quantity *</label>
                                <input type="number" id="memberShipQuantity" min="0" required placeholder="0">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-save-fill"></i> Save Log</button>
                            <button type="button" class="btn btn-warning" onclick="this.closest('form').reset();"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
                        </div>
                    </form>
                </div>
                 <div class="table-container" id="memberShipTableContainer">
                    <div class="export-section">
                        <h4><i class="bi bi-download"></i> Export MemberShip Data</h4>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="exportMemberShipExcel()"><i class="bi bi-file-earmark-excel-fill"></i> Excel</button>
                            <button class="btn btn-danger" onclick="exportMemberShipPDF()"><i class="bi bi-file-earmark-pdf-fill"></i> PDF</button>
                            <button class="btn btn-info" onclick="exportMemberShipImage()"><i class="bi bi-image-fill"></i> Image</button>
                        </div>
                    </div>
                    <h3>MemberShip Log History</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Employee Name</th>
                                <th>Quantity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="memberShipTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Daily Audit Page -->
            <div class="page" id="dailyAudit">
                <div class="header"><h1>Daily Audit Management</h1></div>
                <div class="form-container">
                    <h3>New Audit Entry</h3>
                    <form id="dailyAuditForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="auditDate">Date *</label>
                                <input type="date" id="auditDate" required>
                            </div>
                            <div class="form-group">
                                <label for="auditEmployeeName">Employee Name *</label>
                                <input type="text" id="auditEmployeeName" required placeholder="Enter employee name">
                            </div>
                            <div class="form-group">
                                <label for="auditRackName">Rack Name *</label>
                                <input type="text" id="auditRackName" required placeholder="e.g., Rack A1">
                            </div>
                            <div class="form-group">
                                <label for="auditPageQuantity">Page Quantity *</label>
                                <input type="number" id="auditPageQuantity" min="0" required placeholder="0">
                            </div>
                            <div class="form-group">
                                <label for="auditStatus">Status *</label>
                                <select id="auditStatus" required>
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-save-fill"></i> Save Audit</button>
                            <button type="button" class="btn btn-warning" onclick="this.closest('form').reset();"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="dailyAuditTableContainer">
                    <div class="export-section">
                        <h4><i class="bi bi-download"></i> Export Audit Data</h4>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="exportDailyAuditExcel()"><i class="bi bi-file-earmark-excel-fill"></i> Excel (Daily)</button>
                            <button class="btn btn-warning" onclick="exportMonthlyAuditExcel()"><i class="bi bi-file-earmark-excel-fill"></i> Excel (Monthly)</button>
                            <button class="btn btn-danger" onclick="exportDailyAuditPDF()"><i class="bi bi-file-earmark-pdf-fill"></i> PDF</button>
                            <button class="btn btn-info" onclick="exportDailyAuditImage()"><i class="bi bi-image-fill"></i> Image</button>
                        </div>
                    </div>
                    <h3>Audit History</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Employee Name</th>
                                <th>Rack Name</th>
                                <th>Page Qty</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dailyAuditTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Category Page -->
            <div class="page" id="category">
                <div class="header"><h1>Category Log Management</h1></div>
                <div class="form-container">
                    <h3>New Category Entry</h3>
                    <form id="categoryForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="categoryDate">Date *</label>
                                <input type="date" id="categoryDate" required>
                            </div>
                            <div class="form-group">
                                <label for="categoryName">Category Name *</label>
                                <select id="categoryName" required></select>
                            </div>
                            <div class="form-group">
                                <label for="categoryQuantity">Quantity *</label>
                                <input type="number" id="categoryQuantity" min="0" required placeholder="0">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-save-fill"></i> Save Entry</button>
                            <button type="button" class="btn btn-warning" onclick="this.closest('form').reset();"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="categoryTableContainer">
                    <div class="export-section">
                        <h4><i class="bi bi-download"></i> Export Category Data</h4>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="exportCategoryExcel()"><i class="bi bi-file-earmark-excel-fill"></i> Excel</button>
                            <button class="btn btn-danger" onclick="exportCategoryPDF()"><i class="bi bi-file-earmark-pdf-fill"></i> PDF</button>
                            <button class="btn btn-info" onclick="exportCategoryImage()"><i class="bi bi-image-fill"></i> Image</button>
                            <button class="btn btn-primary" onclick="generateCategoryReport()"><i class="bi bi-bar-chart-fill"></i> Daily Report</button>
                        </div>
                    </div>
                    <table id="categoryReportTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>Category Name</th>
                                <th>Total Quantity</th>
                            </tr>
                        </thead>
                        <tbody id="categoryReportTableBody"></tbody>
                    </table>
                    <h3>Category History</h3>
                    <table id="categoryHistoryTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category Name</th>
                                <th>Quantity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoryTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Page -->
            <div class="page" id="reports">
                <div class="header"><h1>Reports & Analytics</h1></div>
                 <div class="filter-section">
                     <h3>Generate Report</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Report Type</label>
                            <select id="reportType" onchange="toggleReportDateInputs()">
                                <option value="daily">Daily Report</option>
                                <option value="weekly">Weekly Report</option>
                                <option value="monthly">Monthly Report</option>
                                <option value="yearly">Yearly Report</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="form-group" id="reportFromDateContainer">
                            <label>Date</label>
                            <input type="date" id="reportFromDate">
                        </div>
                        <div class="form-group" id="reportToDateContainer" style="display: none;">
                            <label>To Date</label>
                            <input type="date" id="reportToDate">
                        </div>
                    </div>
                     <div class="btn-group">
                        <button class="btn btn-primary" onclick="generateReport()"><i class="bi bi-graph-up"></i> Generate Report</button>
                    </div>
                 </div>
                 
                 <div class="export-section">
                    <h4><i class="bi bi-download"></i> Export Report Data</h4>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="exportReportToExcel()"><i class="bi bi-file-earmark-excel-fill"></i> Excel</button>
                        <button class="btn btn-danger" onclick="exportReportToPDF()"><i class="bi bi-file-earmark-pdf-fill"></i> PDF</button>
                        <button class="btn btn-info" onclick="exportReportImage()"><i class="bi bi-image-fill"></i> Image</button>
                    </div>
                </div>

                 <div class="cards-grid" id="reportCards">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Total Revenue</div>
                                <div class="card-value" id="reportRevenue">₹0.00</div>
                            </div>
                            <div class="card-icon icon-sales"><i class="bi bi-currency-rupee"></i></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Pharma Revenue</div>
                                <div class="card-value" id="reportPharma">₹0.00</div>
                            </div>
                            <div class="card-icon icon-pharma"><i class="bi bi-capsule"></i></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Non-Pharma Revenue</div>
                                <div class="card-value" id="reportNonPharma">₹0.00</div>
                            </div>
                            <div class="card-icon icon-nonpharma"><i class="bi bi-basket-fill"></i></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Deliveries</div>
                                <div class="card-value" id="reportDeliveries">0</div>
                            </div>
                            <div class="card-icon icon-delivery"><i class="bi bi-truck"></i></div>
                        </div>
                    </div>
                </div>
                <div class="chart-container"><canvas id="reportChart"></canvas></div>
            </div>

            <!-- Settings Page -->
            <div class="page" id="settings">
                 <div class="header"><h1>Settings & Configuration</h1></div>
                 <div class="settings-group">
                    <h3>Manage Categories</h3>
                    <form id="addCategoryForm" class="form-grid" style="align-items: end;">
                        <div class="form-group">
                            <label for="newCategoryName">New Category Name</label>
                            <input type="text" id="newCategoryName" required placeholder="Enter category name">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add Category</button>
                        </div>
                    </form>
                    <ul class="category-list" id="categoryList"></ul>
                 </div>
                 <div class="settings-group">
                    <h3>Data Management</h3>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="backupData()"><i class="bi bi-database-down"></i> Backup Data</button>
                        <button class="btn btn-danger" onclick="clearAllData()"><i class="bi bi-trash3-fill"></i> Clear All Data</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Data Storage
        const storage = {
            sales: JSON.parse(localStorage.getItem('pharma_sales')) || [],
            deliveries: JSON.parse(localStorage.getItem('pharma_deliveries')) || [],
            memberShipEntries: JSON.parse(localStorage.getItem('pharma_memberShipEntries')) || [],
            dailyAudits: JSON.parse(localStorage.getItem('pharma_dailyAudits')) || [],
            categories: JSON.parse(localStorage.getItem('pharma_categories')) || ['Default Category'],
            categoryEntries: JSON.parse(localStorage.getItem('pharma_categoryEntries')) || [],
        };
        window.currentReportData = [];
        
        // Helper Functions
        const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
        const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('en-GB');
        const generateId = (prefix) => `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        const showAlert = (message, type = 'success') => {
            const el = document.getElementById('alertMessage');
            el.className = `alert alert-${type} show`;
            el.textContent = message;
            setTimeout(() => { el.className = 'alert'; }, 3000);
        };
        
        const saveToStorage = (key, data) => {
            storage[key] = data;
            localStorage.setItem(`pharma_${key}`, JSON.stringify(data));
        };
        
        const insertEmptyRow = (tbody, colSpan) => {
            tbody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align: center; color: var(--grey-color); padding: 30px;">No data found</td></tr>`;
        }

        // Phone Number Validation
        function validatePhoneNumber(input) {
            const phoneRegex = /^[0-9]{10}$/;
            const errorMsg = document.getElementById(input.id + 'Error');
            
            if (!phoneRegex.test(input.value)) {
                input.classList.add('error');
                if (errorMsg) errorMsg.classList.add('show');
                return false;
            } else {
                input.classList.remove('error');
                if (errorMsg) errorMsg.classList.remove('show');
                return true;
            }
        }

        // Add phone validation on input
        document.addEventListener('DOMContentLoaded', function() {
            const phoneInputs = document.querySelectorAll('input[type="tel"]');
            phoneInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value.length > 10) {
                        this.value = this.value.slice(0, 10);
                    }
                });
                
                input.addEventListener('blur', function() {
                    validatePhoneNumber(this);
                });
            });
        });

        // Navigation
        function showPage(pageId, event) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadPageData(pageId);
            if (window.innerWidth <= 992) toggleMobileMenu();
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            document.getElementById('mainContent').classList.toggle('expanded');
            sidebar.classList.toggle('collapsed');
            const icon = document.querySelector('.toggle-btn i');
            icon.classList.toggle('bi-chevron-left'); 
            icon.classList.toggle('bi-chevron-right');
        }
        
        function toggleMobileMenu() { 
            document.getElementById('sidebar').classList.toggle('mobile-open'); 
            document.getElementById('mobileBackdrop').classList.toggle('active'); 
        }
        
        function loadPageData(pageId) {
            const pageLoaders = {
                dashboard: updateDashboard,
                dailySales: loadRecentSales,
                saleHistory: loadSaleHistory,
                homeDelivery: loadDeliveries,
                memberShip: loadMemberShipEntries,
                dailyAudit: loadDailyAudits,
                category: loadCategoryPage,
                settings: loadSettingsPage,
            };
            if (pageLoaders[pageId]) pageLoaders[pageId]();
        }

        // Dashboard & Charts
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = storage.sales.filter(s => s.date === today);
            
            const todayPharmaTotal = todaySales.reduce((sum, s) => sum + s.pharma, 0);
            const todayNonPharmaTotal = todaySales.reduce((sum, s) => sum + s.nonPharma, 0);
            const todayTotalSales = todayPharmaTotal + todayNonPharmaTotal;
            
            // Update Net Total Daily Sale Card
            document.getElementById('netDailyTotal').textContent = formatCurrency(todayTotalSales);
            document.getElementById('netDailyPharma').textContent = formatCurrency(todayPharmaTotal);
            document.getElementById('netDailyNonPharma').textContent = formatCurrency(todayNonPharmaTotal);
            document.getElementById('netDailyTransactions').textContent = todaySales.length;
            
            // Update other cards
            document.getElementById('todayTotal').textContent = formatCurrency(todayTotalSales);
            document.getElementById('todayPharma').textContent = formatCurrency(todayPharmaTotal);
            document.getElementById('todayNonPharma').textContent = formatCurrency(todayNonPharmaTotal);
            document.getElementById('todayDeliveries').textContent = storage.deliveries.filter(d => d.status === 'Pending').length;
            
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthlySales = storage.sales.filter(s => {
                const saleDate = new Date(s.date);
                return saleDate.getMonth() === thisMonth && saleDate.getFullYear() === thisYear;
            });
            document.getElementById('monthlyTotal').textContent = formatCurrency(monthlySales.reduce((sum, s) => sum + s.pharma + s.nonPharma, 0));
            document.getElementById('totalAudits').textContent = storage.dailyAudits.filter(l => l.date === today).length;
            
            updateDashboardCharts();
        }
        
        function updateDashboardCharts() {
            const salesCtx = document.getElementById('salesChart');
            const categoryCtx = document.getElementById('categoryChart');
            
            if (window.salesChart instanceof Chart) window.salesChart.destroy();
            if (window.categoryChart instanceof Chart) window.categoryChart.destroy();

            // Sales Chart (Last 7 days)
            const salesLabels = [];
            const salesData = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                salesLabels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                const total = storage.sales.filter(s => s.date === dateStr).reduce((sum, s) => sum + s.pharma + s.nonPharma, 0);
                salesData.push(total);
            }
            
            window.salesChart = new Chart(salesCtx, { 
                type: 'line', 
                data: { 
                    labels: salesLabels, 
                    datasets: [{ 
                        label: 'Total Sales (₹)', 
                        data: salesData, 
                        borderColor: '#4f46e5', 
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: 'rgba(79, 70, 229, 0.1)' 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Last 7 Days Sales Trend'
                        }
                    }
                } 
            });

            // Category Chart (Pharma vs Non-Pharma)
            const totalPharma = storage.sales.reduce((sum, s) => sum + s.pharma, 0);
            const totalNonPharma = storage.sales.reduce((sum, s) => sum + s.nonPharma, 0);
            
            window.categoryChart = new Chart(categoryCtx, { 
                type: 'doughnut', 
                data: { 
                    labels: ['Pharma', 'Non-Pharma'], 
                    datasets: [{ 
                        data: [totalPharma, totalNonPharma], 
                        backgroundColor: ['#4f46e5', '#10b981'] 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Sales Distribution'
                        }
                    }
                } 
            });
        }

        // Daily Sales CRUD
        document.getElementById('dailySalesForm').addEventListener('submit', function(e) { 
            e.preventDefault(); 
            const sale = { 
                id: generateId('S'), 
                date: this.querySelector('#saleDate').value, 
                pharma: parseFloat(this.querySelector('#pharmaAmount').value) || 0, 
                nonPharma: parseFloat(this.querySelector('#nonPharmaAmount').value) || 0 
            }; 
            storage.sales.unshift(sale); 
            saveToStorage('sales', storage.sales); 
            showAlert('Sale recorded successfully!'); 
            this.reset(); 
            this.querySelector('#saleDate').value = new Date().toISOString().split('T')[0]; 
            loadRecentSales(); 
            updateDashboard(); 
        });
        
        function loadRecentSales() { 
            const tbody = document.getElementById('recentSalesTable'); 
            if (storage.sales.length === 0) return insertEmptyRow(tbody, 5); 
            tbody.innerHTML = storage.sales.slice(0, 5).map(s => 
                `<tr>
                    <td>${formatDate(s.date)}</td>
                    <td>${formatCurrency(s.pharma)}</td>
                    <td>${formatCurrency(s.nonPharma)}</td>
                    <td><strong>${formatCurrency(s.pharma + s.nonPharma)}</strong></td>
                    <td><button class="action-btn delete-btn" onclick="deleteSale('${s.id}')"><i class="bi bi-trash-fill"></i></button></td>
                </tr>`
            ).join(''); 
        }
        
        function deleteSale(id) { 
            if (!confirm('Delete this sale record?')) return; 
            storage.sales = storage.sales.filter(s => s.id !== id); 
            saveToStorage('sales', storage.sales); 
            showAlert('Sale deleted successfully.'); 
            loadRecentSales(); 
            loadSaleHistory(); 
            updateDashboard(); 
        }
        
        function loadSaleHistory() { 
            const tbody = document.getElementById('saleHistoryTable'); 
            if (storage.sales.length === 0) return insertEmptyRow(tbody, 5); 
            tbody.innerHTML = storage.sales.map(s => 
                `<tr>
                    <td>${formatDate(s.date)}</td>
                    <td>${formatCurrency(s.pharma)}</td>
                    <td>${formatCurrency(s.nonPharma)}</td>
                    <td><strong>${formatCurrency(s.pharma + s.nonPharma)}</strong></td>
                    <td><button class="action-btn delete-btn" onclick="deleteSale('${s.id}')"><i class="bi bi-trash-fill"></i></button></td>
                </tr>`
            ).join(''); 
        }
        
        // Home Delivery CRUD
        document.getElementById('deliveryForm').addEventListener('submit', function(e){ 
            e.preventDefault(); 
            
            const phoneInput = this.querySelector('#deliveryPhone');
            if (!validatePhoneNumber(phoneInput)) {
                showAlert('Please enter a valid 10-digit phone number!', 'error');
                return;
            }
            
            const delivery = { 
                id: generateId('D'), 
                customerId: this.querySelector('#deliveryCustomerId').value,
                date: this.querySelector('#deliveryDate').value, 
                customer: this.querySelector('#deliveryCustomer').value, 
                phone: phoneInput.value, 
                status: this.querySelector('#deliveryStatus').value, 
                address: this.querySelector('#deliveryAddress').value 
            }; 
            
            storage.deliveries.unshift(delivery); 
            saveToStorage('deliveries', storage.deliveries); 
            showAlert('Delivery order created successfully!'); 
            this.reset(); 
            this.querySelector('#deliveryDate').value = new Date().toISOString().split('T')[0]; 
            loadDeliveries(); 
            updateDashboard(); 
        });
        
        function loadDeliveries(){ 
            const tbody = document.getElementById('deliveryTable'); 
            if (storage.deliveries.length === 0) return insertEmptyRow(tbody, 7); 
            tbody.innerHTML = storage.deliveries.map(d => 
                `<tr>
                    <td>${d.customerId}</td>
                    <td>${formatDate(d.date)}</td>
                    <td>${d.customer}</td>
                    <td>${d.phone}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${d.address}</td>
                    <td><span class="badge">${d.status}</span></td>
                    <td><button class="action-btn delete-btn" onclick="deleteDelivery('${d.id}')"><i class="bi bi-trash-fill"></i></button></td>
                </tr>`
            ).join(''); 
        }
        
        function deleteDelivery(id){ 
            if (!confirm('Delete this delivery order?')) return; 
            storage.deliveries = storage.deliveries.filter(d => d.id !== id); 
            saveToStorage('deliveries', storage.deliveries); 
            showAlert('Delivery deleted successfully.'); 
            loadDeliveries(); 
            updateDashboard(); 
        }

        // MemberShip CRUD
        document.getElementById('memberShipForm').addEventListener('submit', function(e){ 
            e.preventDefault(); 
            const log = { 
                id: generateId('M'), 
                date: this.querySelector('#memberShipDate').value, 
                name: this.querySelector('#memberShipName').value, 
                quantity: parseInt(this.querySelector('#memberShipQuantity').value) || 0 
            }; 
            storage.memberShipEntries.unshift(log); 
            saveToStorage('memberShipEntries', storage.memberShipEntries); 
            showAlert('MemberShip log entry saved successfully!'); 
            this.reset(); 
            this.querySelector('#memberShipDate').value = new Date().toISOString().split('T')[0]; 
            loadMemberShipEntries(); 
        });
        
        function loadMemberShipEntries(){ 
            const tbody = document.getElementById('memberShipTable'); 
            if (storage.memberShipEntries.length === 0) return insertEmptyRow(tbody, 4); 
            tbody.innerHTML = storage.memberShipEntries.map(l => 
                `<tr>
                    <td>${formatDate(l.date)}</td>
                    <td>${l.name}</td>
                    <td>${l.quantity}</td>
                    <td><button class="action-btn delete-btn" onclick="deleteMemberShipEntry('${l.id}')"><i class="bi bi-trash-fill"></i></button></td>
                </tr>`
            ).join(''); 
        }
        
        function deleteMemberShipEntry(id){ 
            if (!confirm('Delete this membership log?')) return; 
            storage.memberShipEntries = storage.memberShipEntries.filter(l => l.id !== id); 
            saveToStorage('memberShipEntries', storage.memberShipEntries); 
            showAlert('MemberShip log deleted successfully.'); 
            loadMemberShipEntries(); 
        }
        
        // Daily Audit CRUD
        document.getElementById('dailyAuditForm').addEventListener('submit', function(e) { 
            e.preventDefault(); 
            const audit = { 
                id: generateId('A'), 
                date: this.querySelector('#auditDate').value, 
                employeeName: this.querySelector('#auditEmployeeName').value, 
                rackName: this.querySelector('#auditRackName').value, 
                pageQuantity: parseInt(this.querySelector('#auditPageQuantity').value) || 0, 
                status: this.querySelector('#auditStatus').value 
            }; 
            storage.dailyAudits.unshift(audit); 
            saveToStorage('dailyAudits', storage.dailyAudits); 
            showAlert('Audit entry saved successfully!'); 
            this.reset(); 
            this.querySelector('#auditDate').value = new Date().toISOString().split('T')[0]; 
            loadDailyAudits(); 
            updateDashboard(); 
        });
        
        function loadDailyAudits() { 
            const tbody = document.getElementById('dailyAuditTable'); 
            if (storage.dailyAudits.length === 0) return insertEmptyRow(tbody, 6); 
            tbody.innerHTML = storage.dailyAudits.map(a => 
                `<tr>
                    <td>${formatDate(a.date)}</td>
                    <td>${a.employeeName}</td>
                    <td>${a.rackName}</td>
                    <td>${a.pageQuantity}</td>
                    <td>${a.status}</td>
                    <td><button class="action-btn delete-btn" onclick="deleteDailyAudit('${a.id}')"><i class="bi bi-trash-fill"></i></button></td>
                </tr>`
            ).join(''); 
        }
        
        function deleteDailyAudit(id) { 
            if (!confirm('Delete this audit entry?')) return; 
            storage.dailyAudits = storage.dailyAudits.filter(a => a.id !== id); 
            saveToStorage('dailyAudits', storage.dailyAudits); 
            showAlert('Audit deleted successfully.'); 
            loadDailyAudits(); 
            updateDashboard(); 
        }
        
        // Category CRUD
        function loadCategoryPage() { 
            populateCategoryDropdown(); 
            loadCategoryEntries(); 
            document.getElementById('categoryReportTable').style.display = 'none'; 
            document.getElementById('categoryHistoryTable').style.display = 'table'; 
        }
        
        function populateCategoryDropdown() { 
            const select = document.getElementById('categoryName'); 
            if (storage.categories.length > 0) { 
                select.innerHTML = storage.categories.map(cat => `<option value="${cat}">${cat}</option>`).join(''); 
            } else { 
                select.innerHTML = '<option disabled>Please add a category in Settings</option>'; 
            } 
        }
        
        function loadCategoryEntries() { 
            const tbody = document.getElementById('categoryTableBody'); 
            if (storage.categoryEntries.length === 0) return insertEmptyRow(tbody, 4); 
            tbody.innerHTML = storage.categoryEntries.map(e => 
                `<tr>
                    <td>${formatDate(e.date)}</td>
                    <td>${e.name}</td>
                    <td>${e.quantity}</td>
                    <td><button class="action-btn delete-btn" onclick="deleteCategoryEntry('${e.id}')"><i class="bi bi-trash-fill"></i></button></td>
                </tr>`
            ).join(''); 
        }
        
        document.getElementById('categoryForm').addEventListener('submit', function(e) { 
            e.preventDefault(); 
            if (storage.categories.length === 0) return showAlert('Please add a category in Settings first.', 'error'); 
            const entry = { 
                id: generateId('C'), 
                date: this.querySelector('#categoryDate').value, 
                name: this.querySelector('#categoryName').value, 
                quantity: parseInt(this.querySelector('#categoryQuantity').value) || 0 
            }; 
            storage.categoryEntries.unshift(entry); 
            saveToStorage('categoryEntries', storage.categoryEntries); 
            showAlert('Category entry saved successfully!'); 
            this.reset(); 
            this.querySelector('#categoryDate').value = new Date().toISOString().split('T')[0]; 
            loadCategoryEntries(); 
        });
        
        function deleteCategoryEntry(id) { 
            if (!confirm('Delete this category entry?')) return; 
            storage.categoryEntries = storage.categoryEntries.filter(e => e.id !== id); 
            saveToStorage('categoryEntries', storage.categoryEntries); 
            showAlert('Category entry deleted successfully.'); 
            loadCategoryEntries(); 
        }
        
        function generateCategoryReport() { 
            const date = document.getElementById('categoryDate').value; 
            if (!date) return showAlert('Please select a date to generate the report.', 'error'); 
            
            const entries = storage.categoryEntries.filter(e => e.date === date); 
            if (!entries.length) return showAlert(`No category entries found for ${formatDate(date)}.`, 'warning'); 
            
            const reportData = entries.reduce((acc, entry) => { 
                acc[entry.name] = (acc[entry.name] || 0) + entry.quantity; 
                return acc; 
            }, {}); 
            
            const tbody = document.getElementById('categoryReportTableBody'); 
            tbody.innerHTML = Object.entries(reportData).map(([name, qty]) => 
                `<tr><td>${name}</td><td>${qty}</td></tr>`
            ).join(''); 
            
            document.getElementById('categoryHistoryTable').style.display = 'none'; 
            document.getElementById('categoryReportTable').style.display = 'table'; 
            showAlert('Daily category report generated successfully!', 'success'); 
        }
        
        // Reports Functions
        function toggleReportDateInputs() { 
            const type = document.getElementById('reportType').value; 
            const fromC = document.getElementById('reportFromDateContainer'); 
            const toC = document.getElementById('reportToDateContainer'); 
            const fromL = fromC.querySelector('label'); 
            fromC.style.display = 'block'; 
            
            if (type === 'custom') { 
                fromL.textContent = 'From Date'; 
                toC.style.display = 'block'; 
            } else { 
                fromL.textContent = 'Select Date'; 
                toC.style.display = 'none'; 
            } 
        }
        
        function generateReport() { 
            const type = document.getElementById('reportType').value; 
            const fromDateStr = document.getElementById('reportFromDate').value; 
            
            if (!fromDateStr) return showAlert('Please select a date for the report.', 'error'); 
            
            let start, end; 
            const fromDate = new Date(fromDateStr); 
            const toDateStr = document.getElementById('reportToDate').value; 
            
            switch(type) { 
                case 'daily': 
                    start = fromDate; 
                    end = fromDate; 
                    break; 
                case 'weekly': 
                    end = fromDate; 
                    start = new Date(fromDate); 
                    start.setDate(start.getDate() - 6); 
                    break; 
                case 'monthly': 
                    start = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1); 
                    end = new Date(fromDate.getFullYear(), fromDate.getMonth() + 1, 0); 
                    break; 
                case 'yearly': 
                    start = new Date(fromDate.getFullYear(), 0, 1); 
                    end = new Date(fromDate.getFullYear(), 11, 31); 
                    break; 
                case 'custom': 
                    if (!toDateStr) return showAlert('Please select an end date.', 'error'); 
                    start = fromDate; 
                    end = new Date(toDateStr); 
                    break; 
            } 
            
            const startStr = start.toISOString().split('T')[0]; 
            const endStr = end.toISOString().split('T')[0]; 
            const filteredSales = storage.sales.filter(s => s.date >= startStr && s.date <= endStr); 
            
            if (!filteredSales.length) { 
                window.currentReportData = []; 
                return showAlert('No sales data found for the selected period.', 'warning'); 
            } 
            
            window.currentReportData = filteredSales; 
            
            const totalRevenue = filteredSales.reduce((sum, s) => sum + s.pharma + s.nonPharma, 0);
            const totalPharma = filteredSales.reduce((sum, s) => sum + s.pharma, 0);
            const totalNonPharma = filteredSales.reduce((sum, s) => sum + s.nonPharma, 0);
            
            document.getElementById('reportRevenue').textContent = formatCurrency(totalRevenue); 
            document.getElementById('reportPharma').textContent = formatCurrency(totalPharma); 
            document.getElementById('reportNonPharma').textContent = formatCurrency(totalNonPharma); 
            document.getElementById('reportDeliveries').textContent = storage.deliveries.filter(d => d.date >= startStr && d.date <= endStr).length; 
            
            updateReportChart(filteredSales); 
            showAlert('Report generated successfully!', 'success'); 
        }
        
        function updateReportChart(salesData) { 
            const reportCtx = document.getElementById('reportChart'); 
            const groupedData = salesData.reduce((acc, sale) => { 
                const date = formatDate(sale.date); 
                acc[date] = (acc[date] || 0) + sale.pharma + sale.nonPharma; 
                return acc; 
            }, {}); 
            
            if(window.reportChart) window.reportChart.destroy(); 
            
            window.reportChart = new Chart(reportCtx, { 
                type: 'bar', 
                data: { 
                    labels: Object.keys(groupedData), 
                    datasets: [{ 
                        label: 'Total Sales (₹)', 
                        data: Object.values(groupedData), 
                        backgroundColor: '#4f46e5' 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true 
                        } 
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sales Report Chart'
                        }
                    }
                } 
            }); 
        }
        
        // Settings & Category Management
        function loadSettingsPage() { 
            const list = document.getElementById('categoryList'); 
            list.innerHTML = ''; 
            storage.categories.forEach(cat => { 
                const item = document.createElement('li'); 
                item.className = 'category-list-item'; 
                item.innerHTML = `<span><i class="bi bi-tag-fill"></i> ${cat}</span><button class="btn btn-danger" style="padding: 6px 12px;" onclick="removeCategory('${cat}')"><i class="bi bi-trash-fill"></i></button>`; 
                list.appendChild(item); 
            }); 
        }
        
        document.getElementById('addCategoryForm').addEventListener('submit', function(e) { 
            e.preventDefault(); 
            const newCat = document.getElementById('newCategoryName').value.trim(); 
            
            if (newCat && !storage.categories.includes(newCat)) { 
                storage.categories.push(newCat); 
                saveToStorage('categories', storage.categories); 
                showAlert(`Category "${newCat}" added successfully.`); 
                loadSettingsPage(); 
                this.reset(); 
            } else { 
                showAlert('Category already exists or is invalid.', 'error'); 
            } 
        });
        
        function removeCategory(catName) { 
            if (storage.categories.length <= 1) return showAlert('Cannot remove the last category.', 'error'); 
            
            if (confirm(`Remove category "${catName}"? This action cannot be undone.`)) { 
                storage.categories = storage.categories.filter(c => c !== catName); 
                saveToStorage('categories', storage.categories); 
                showAlert(`Category "${catName}" removed successfully.`); 
                loadSettingsPage(); 
            } 
        }
        
        // Export Functions - Excel
        function exportDeliveryExcel() { 
            if (!storage.deliveries.length) return showAlert('No delivery data to export.', 'error'); 
            
            const data = storage.deliveries.map(d => ({ 
                'Customer ID': d.customerId,
                'Date': d.date, 
                'Customer Name': d.customer, 
                'Phone': d.phone, 
                'Address': d.address,
                'Status': d.status 
            })); 
            
            const ws = XLSX.utils.json_to_sheet(data); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "Deliveries"); 
            XLSX.writeFile(wb, `Home_Delivery_${new Date().toISOString().split('T')[0]}.xlsx`); 
            showAlert('Delivery data exported to Excel successfully!');
        }

        function exportMemberShipExcel() { 
            if (!storage.memberShipEntries.length) return showAlert('No membership data to export.', 'error'); 
            
            const data = storage.memberShipEntries.map(m => ({ 
                'Date': m.date, 
                'Employee Name': m.name, 
                'Quantity': m.quantity 
            })); 
            
            const ws = XLSX.utils.json_to_sheet(data); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "MemberShip"); 
            XLSX.writeFile(wb, `MemberShip_${new Date().toISOString().split('T')[0]}.xlsx`); 
            showAlert('MemberShip data exported to Excel successfully!');
        }

        function exportDailyAuditExcel() { 
            const date = document.getElementById('auditDate').value; 
            if (!date) return showAlert('Select a date to export daily audit.', 'error'); 
            
            const data = storage.dailyAudits.filter(a => a.date === date); 
            if (!data.length) return showAlert(`No audit data for ${formatDate(date)}.`, 'error'); 
            
            const exportData = data.map(a => ({
                'Date': a.date,
                'Employee Name': a.employeeName,
                'Rack Name': a.rackName,
                'Page Quantity': a.pageQuantity,
                'Status': a.status
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, `Audit ${date}`); 
            XLSX.writeFile(wb, `Daily_Audit_${date}.xlsx`); 
            showAlert('Daily audit exported to Excel successfully!');
        }

        function exportMonthlyAuditExcel() { 
            const dateStr = document.getElementById('auditDate').value; 
            if (!dateStr) return showAlert('Select a date to determine the month.', 'error'); 
            
            const dateObj = new Date(dateStr); 
            const data = storage.dailyAudits.filter(a => { 
                const auditDate = new Date(a.date); 
                return auditDate.getFullYear() === dateObj.getFullYear() && auditDate.getMonth() === dateObj.getMonth(); 
            }); 
            
            if (!data.length) return showAlert(`No audit data for ${dateObj.toLocaleString('default', { month: 'long', year: 'numeric' })}.`, 'error'); 
            
            const exportData = data.map(a => ({
                'Date': a.date,
                'Employee Name': a.employeeName,
                'Rack Name': a.rackName,
                'Page Quantity': a.pageQuantity,
                'Status': a.status
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, `Audit`); 
            XLSX.writeFile(wb, `Monthly_Audit_${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}.xlsx`); 
            showAlert('Monthly audit exported to Excel successfully!');
        }

        function exportCategoryExcel() { 
            if (!storage.categoryEntries.length) return showAlert('No category data to export.', 'error'); 
            
            const data = storage.categoryEntries.map(c => ({ 
                'Date': c.date, 
                'Category Name': c.name, 
                'Quantity': c.quantity 
            })); 
            
            const ws = XLSX.utils.json_to_sheet(data); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "Category"); 
            XLSX.writeFile(wb, `Category_Log_${new Date().toISOString().split('T')[0]}.xlsx`); 
            showAlert('Category data exported to Excel successfully!');
        }

        function exportReportToExcel() { 
            if (!window.currentReportData.length) return showAlert('Generate a report first.', 'error'); 
            
            const data = window.currentReportData.map(s => ({ 
                'Date': s.date, 
                'Pharma Sales (₹)': s.pharma, 
                'Non-Pharma Sales (₹)': s.nonPharma, 
                'Total (₹)': s.pharma + s.nonPharma 
            })); 
            
            const ws = XLSX.utils.json_to_sheet(data); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "Report"); 
            XLSX.writeFile(wb, `Sales_Report_${new Date().toISOString().split('T')[0]}.xlsx`); 
            showAlert('Report exported to Excel successfully!');
        }

        // Export Functions - PDF
        function exportDeliveryPDF() { 
            if (!storage.deliveries.length) return showAlert('No delivery data to export.', 'error'); 
            
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF(); 
            
            doc.setFontSize(16);
            doc.text('Home Delivery Report', 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 14, 22);
            
            const tableData = storage.deliveries.map(d => [
                d.customerId,
                formatDate(d.date), 
                d.customer, 
                d.phone, 
                d.address.substring(0, 30) + '...',
                d.status
            ]); 
            
            doc.autoTable({ 
                startY: 28,
                head: [['Customer ID', 'Date', 'Customer', 'Phone', 'Address', 'Status']], 
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 8 }
            }); 
            
            doc.save(`Home_Delivery_${new Date().toISOString().split('T')[0]}.pdf`); 
            showAlert('Delivery data exported to PDF successfully!');
        }

        function exportMemberShipPDF() { 
            if (!storage.memberShipEntries.length) return showAlert('No membership data to export.', 'error'); 
            
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF(); 
            
            doc.setFontSize(16);
            doc.text('MemberShip Report', 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 14, 22);
            
            const tableData = storage.memberShipEntries.map(m => [
                formatDate(m.date), 
                m.name, 
                m.quantity.toString()
            ]); 
            
            doc.autoTable({ 
                startY: 28,
                head: [['Date', 'Employee Name', 'Quantity']], 
                body: tableData,
                theme: 'grid'
            }); 
            
            doc.save(`MemberShip_${new Date().toISOString().split('T')[0]}.pdf`); 
            showAlert('MemberShip data exported to PDF successfully!');
        }

        function exportDailyAuditPDF() { 
            if (!storage.dailyAudits.length) return showAlert('No audit data to export.', 'error'); 
            
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF(); 
            
            doc.setFontSize(16);
            doc.text('Daily Audit Report', 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 14, 22);
            
            const tableData = storage.dailyAudits.map(a => [
                formatDate(a.date), 
                a.employeeName, 
                a.rackName,
                a.pageQuantity.toString(),
                a.status
            ]); 
            
            doc.autoTable({ 
                startY: 28,
                head: [['Date', 'Employee', 'Rack', 'Pages', 'Status']], 
                body: tableData,
                theme: 'grid'
            }); 
            
            doc.save(`Daily_Audit_${new Date().toISOString().split('T')[0]}.pdf`); 
            showAlert('Audit data exported to PDF successfully!');
        }

        function exportCategoryPDF() { 
            if (!storage.categoryEntries.length) return showAlert('No category data to export.', 'error'); 
            
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF(); 
            
            doc.setFontSize(16);
            doc.text('Category Log Report', 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 14, 22);
            
            const tableData = storage.categoryEntries.map(c => [
                formatDate(c.date), 
                c.name, 
                c.quantity.toString()
            ]); 
            
            doc.autoTable({ 
                startY: 28,
                head: [['Date', 'Category Name', 'Quantity']], 
                body: tableData,
                theme: 'grid'
            }); 
            
            doc.save(`Category_Log_${new Date().toISOString().split('T')[0]}.pdf`); 
            showAlert('Category data exported to PDF successfully!');
        }

        function exportReportToPDF() { 
            if (!window.currentReportData.length) return showAlert('Generate a report first.', 'error'); 
            
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF(); 
            
            doc.setFontSize(16);
            doc.text('Sales Report', 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 14, 22);
            
            const tableData = window.currentReportData.map(s => [
                formatDate(s.date), 
                formatCurrency(s.pharma), 
                formatCurrency(s.nonPharma), 
                formatCurrency(s.pharma + s.nonPharma)
            ]); 
            
            doc.autoTable({ 
                startY: 28,
                head: [['Date', 'Pharma (₹)', 'Non-Pharma (₹)', 'Total (₹)']], 
                body: tableData,
                theme: 'grid'
            }); 
            
            doc.save(`Sales_Report_${new Date().toISOString().split('T')[0]}.pdf`); 
            showAlert('Report exported to PDF successfully!');
        }

        // Export Functions - Image (Screenshot)
        function exportDeliveryImage() {
            const container = document.getElementById('deliveryTableContainer');
            captureAndDownload(container, 'Home_Delivery_Report');
        }

        function exportMemberShipImage() {
            const container = document.getElementById('memberShipTableContainer');
            captureAndDownload(container, 'MemberShip_Report');
        }

        function exportDailyAuditImage() {
            const container = document.getElementById('dailyAuditTableContainer');
            captureAndDownload(container, 'Daily_Audit_Report');
        }

        function exportCategoryImage() {
            const container = document.getElementById('categoryTableContainer');
            captureAndDownload(container, 'Category_Log_Report');
        }

        function exportReportImage() {
            const container = document.getElementById('reportCards');
            captureAndDownload(container, 'Sales_Report');
        }

        function captureAndDownload(element, filename) {
            showAlert('Generating image... Please wait.', 'success');
            
            html2canvas(element, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false
            }).then(canvas => {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    showAlert('Image exported successfully!', 'success');
                });
            }).catch(err => {
                console.error('Screenshot error:', err);
                showAlert('Error generating image. Please try again.', 'error');
            });
        }

        // Data Management
        function backupData() { 
            const dataStr = JSON.stringify(storage, null, 2); 
            const blob = new Blob([dataStr], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `PharmaCare_Backup_${new Date().toISOString().split('T')[0]}.json`; 
            a.click(); 
            URL.revokeObjectURL(url); 
            showAlert('Data backup created successfully!'); 
        }
        
        function clearAllData() { 
            if (confirm('⚠️ DANGER: This will delete ALL data permanently. This action cannot be undone. Are you absolutely sure?')) { 
                if (confirm('Final confirmation: Delete all data?')) {
                    localStorage.clear(); 
                    Object.keys(storage).forEach(key => {
                        if (key === 'categories') {
                            storage[key] = ['Default Category'];
                        } else {
                            storage[key] = [];
                        }
                    }); 
                    showAlert('All data has been cleared successfully.'); 
                    setTimeout(() => window.location.reload(), 1500);
                }
            } 
        }

        // Initialization
        window.addEventListener('load', () => {
            const todayISO = new Date().toISOString().split('T')[0];
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-IN', { 
                weekday: 'long',
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Set default dates
            const dateInputs = [
                'saleDate', 'deliveryDate', 'memberShipDate', 
                'auditDate', 'reportFromDate', 'reportToDate', 'categoryDate'
            ];
            
            dateInputs.forEach(id => {
                const input = document.getElementById(id);
                if(input) input.value = todayISO;
            });
            
            toggleReportDateInputs();
            loadPageData('dashboard');
        });
    </script>
</body>
</html>